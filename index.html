
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesControl - Sistema de Controle de Vendas e Metas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --danger: #e63946;
            --warning: #fca311;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 60px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            padding-top: 80px;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        
        .stats-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stats-card h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .stats-card p {
            color: #6c757d;
            margin-bottom: 0;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }
        
        .table th {
            font-weight: 600;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .config-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .config-card:hover {
            transform: translateY(-5px);
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding-top: 15px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .backup-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand ms-3" href="#" id="dashboardBrandLink">
                <i class="fas fa-chart-line me-2"></i>SalesControl
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar col-lg-2 d-none d-lg-block">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="dashboardLink">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="vendedorasLink">
                    <i class="fas fa-users"></i> Vendedoras
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="vendasLink">
                    <i class="fas fa-shopping-cart"></i> Registrar Vendas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="relatoriosLink">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="configuracoesLink">
                    <i class="fas fa-cog"></i> Configurações
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Dashboard</h2>
                <div>
                    <select class="form-select" id="periodFilter">
                        <option value="day">Hoje</option>
                        <option value="week">Esta Semana</option>
                        <option value="month" selected>Este Mês</option>
                        <option value="year">Este Ano</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-money-bill-wave"></i>
                        <h2 id="valorLiquido">R$ 0,00</h2>
                        <p>Valor Líquido Faturado</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-store"></i>
                        <h2 id="valorConsignado">R$ 0,00</h2>
                        <p>Vendas no Consignado</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-bullseye"></i>
                        <h2 id="metaAtingida">0%</h2>
                        <p>Meta Atingida</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-shopping-bag"></i>
                        <h2 id="pecasFaturadas">0</h2>
                        <p>Peças Faturadas</p>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            Desempenho das Vendedoras
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="desempenhoTable">
                                    <thead>
                                        <tr>
                                            <th>Vendedora</th>
                                            <th>Meta</th>
                                            <th>Alcançado</th>
                                            <th>Progresso</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Conteúdo preenchido por JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Resumo do Mês
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Vendas Efetuadas
                                    <span class="badge bg-primary rounded-pill" id="vendasEfetuadas">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Peças Faturadas
                                    <span class="badge bg-primary rounded-pill" id="totalPecas">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Venda Média Líquida
                                    <span class="badge bg-success rounded-pill" id="vendaMedia">R$ 0,00</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Itens por Venda
                                    <span class="badge bg-info rounded-pill" id="itensPorVenda">0,0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Preço Médio
                                    <span class="badge bg-warning rounded-pill" id="precoMedio">R$ 0,00</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vendedoras Section (Hidden by default) -->
        <div id="vendedorasSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Gerenciar Vendedoras</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVendedoraModal">
                    <i class="fas fa-plus me-1"></i> Nova Vendedora
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    Lista de Vendedoras
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="vendedorasTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Meta Mensal</th>
                                    <th>Contato</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Conteúdo preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vendas Section (Hidden by default) -->
        <div id="vendasSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Registrar Vendas</h2>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVendaModal">
                        <i class="fas fa-plus me-1"></i> Nova Venda
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Vendas Registradas
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="vendasTable">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Vendedora</th>
                                    <th>Valor Líquido</th>
                                    <th>Consignado</th>
                                    <th>Peças</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Conteúdo preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios Section (Hidden by default) -->
        <div id="relatoriosSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Relatórios</h2>
                <div>
                    <button class="btn btn-primary" id="generatePdf">
                        <i class="fas fa-download me-1"></i> Baixar PDF
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Vendedora</label>
                            <select class="form-select" id="filtroVendedora">
                                <option value="todas" selected>Todas</option>
                                <!-- Opções preenchidas por JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Período</label>
                            <select class="form-select" id="filtroPeriodo">
                                <option value="day">Dia</option>
                                <option value="week">Semana</option>
                                <option value="month" selected>Mês</option>
                                <option value="year">Ano</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="dataInicio">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="dataFim">
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-primary" id="aplicarFiltro">
                        <i class="fas fa-filter me-1"></i> Filtrar
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Relatório de Desempenho
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="reportTable">
                            <thead>
                                <tr>
                                    <th>Vendedora</th>
                                    <th>Meta</th>
                                    <th>Valor Líquido</th>
                                    <th>Consignado</th>
                                    <th>Total</th>
                                    <th>Meta Alcançada</th>
                                    <th>Vendas</th>
                                    <th>Peças</th>
                                    <th>Venda Média</th>
                                    <th>Itens/Venda</th>
                                    <th>Preço Médio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Conteúdo preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurações Section (Hidden by default) -->
        <div id="configuracoesSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Configurações</h2>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card config-card" data-bs-toggle="modal" data-bs-target="#backupModal">
                        <div class="card-body text-center">
                            <i class="fas fa-database fa-3x mb-3 text-primary"></i>
                            <h5 class="card-title">Backup de Dados</h5>
                            <p class="card-text">Faça backup ou restaure os dados do sistema</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card config-card">
                        <div class="card-body text-center">
                            <i class="fas fa-info-circle fa-3x mb-3 text-info"></i>
                            <h5 class="card-title">Sobre o Sistema</h5>
                            <p class="card-text">SalesControl v1.0 - Desenvolvido para gestão de vendas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Vendedora -->
    <div class="modal fade" id="addVendedoraModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Vendedora</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formVendedora">
                        <input type="hidden" id="vendedoraId">
                        <div class="mb-3">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="vendedoraNome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Meta Mensal (R$)</label>
                            <input type="number" class="form-control" id="vendedoraMeta" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="vendedoraTelefone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="vendedoraEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarVendedora">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Venda -->
    <div class="modal fade" id="addVendaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formVenda">
                        <input type="hidden" id="vendaId">
                        <div class="mb-3">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" id="vendaData" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vendedora</label>
                            <select class="form-select" id="vendaVendedora" required>
                                <option value="" selected>Selecione...</option>
                                <!-- Opções preenchidas por JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor Líquido Faturado (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="vendaValorLiquido" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vendas no Consignado (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="vendaConsignado" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantidade de Peças Faturadas</label>
                            <input type="number" class="form-control" id="vendaPecas" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarVenda">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Backup -->
    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Backup de Dados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Fazer Backup</h6>
                        <p>Exporte todos os dados do sistema para um arquivo JSON.</p>
                        <button class="btn btn-primary" id="exportBackup">
                            <i class="fas fa-download me-1"></i> Exportar Dados
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div>
                        <h6>Restaurar Backup</h6>
                        <p>Importe dados de um arquivo JSON previamente exportado.</p>
                        <div class="mb-3">
                            <label for="backupFile" class="form-label">Selecionar arquivo de backup</label>
                            <input class="form-control" type="file" id="backupFile" accept=".json">
                        </div>
                        <button class="btn btn-success" id="importBackup">
                            <i class="fas fa-upload me-1"></i> Importar Dados
                        </button>
                    </div>
                    
                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        A importação de dados substituirá todos os dados atuais do sistema.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Exclusão -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicialização e variáveis globais
        let vendedoras = JSON.parse(localStorage.getItem('vendedoras')) || [];
        let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
        let itemParaExcluir = null;
        let tipoItemParaExcluir = '';
        let dadosFiltrados = [];

        // Dados iniciais de exemplo se não houver dados salvos
        if (vendedoras.length === 0) {
            vendedoras = [
                { id: 1, nome: "Maria Silva", meta: 15000, telefone: "(11) 99999-9999", email: "", status: "Ativa" },
                { id: 2, nome: "Joana Santos", meta: 12000, telefone: "(11) 98888-8888", email: "", status: "Ativa" },
                { id: 3, nome: "Ana Costa", meta: 10000, telefone: "(11) 97777-7777", email: "", status: "Ativa" },
                { id: 4, nome: "Carla Oliveira", meta: 8000, telefone: "(11) 96666-6666", email: "", status: "Ativa" }
            ];
            localStorage.setItem('vendedoras', JSON.stringify(vendedoras));
        }

        if (vendas.length === 0) {
            const hoje = new Date();
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1);
            
            vendas = [
                { id: 1, data: formatarData(hoje), vendedoraId: 1, valorLiquido: 850, consignado: 120, pecas: 5 },
                { id: 2, data: formatarData(hoje), vendedoraId: 2, valorLiquido: 620, consignado: 80, pecas: 3 },
                { id: 3, data: formatarData(ontem), vendedoraId: 3, valorLiquido: 450, consignado: 50, pecas: 2 },
                { id: 4, data: formatarData(ontem), vendedoraId: 4, valorLiquido: 920, consignado: 150, pecas: 4 }
            ];
            localStorage.setItem('vendas', JSON.stringify(vendas));
        }

        // Funções utilitárias
        function formatarData(data) {
            return data.toISOString().split('T')[0];
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        function obterVendedoraPorId(id) {
            return vendedoras.find(v => v.id === id);
        }

        function calcularDesempenhoVendedoras(vendasFiltradas = vendas) {
            const desempenho = [];
            
            vendedoras.forEach(vendedora => {
                const vendasVendedora = vendasFiltradas.filter(v => v.vendedoraId === vendedora.id);
                const totalValorLiquido = vendasVendedora.reduce((acc, v) => acc + v.valorLiquido, 0);
                const totalConsignado = vendasVendedora.reduce((acc, v) => acc + v.consignado, 0);
                const totalVendas = vendasVendedora.length;
                const totalPecas = vendasVendedora.reduce((acc, v) => acc + v.pecas, 0);
                
                const metaAtingida = vendedora.meta > 0 ? (totalValorLiquido / vendedora.meta) * 100 : 0;
                
                // CORREÇÃO: Venda Média é o valor líquido dividido pelo número de vendas
                const vendaMedia = totalVendas > 0 ? (totalValorLiquido / totalVendas) : 0;
                
                desempenho.push({
                    vendedora: vendedora.nome,
                    meta: vendedora.meta,
                    valorLiquido: totalValorLiquido,
                    consignado: totalConsignado,
                    total: totalValorLiquido + totalConsignado,
                    metaAtingida: metaAtingida,
                    vendas: totalVendas,
                    pecas: totalPecas,
                    vendaMedia: vendaMedia,
                    itensPorVenda: totalVendas > 0 ? (totalPecas / totalVendas) : 0,
                    precoMedio: totalPecas > 0 ? (totalValorLiquido / totalPecas) : 0
                });
            });
            
            return desempenho;
        }

        function calcularResumoGeral(vendasFiltradas = vendas) {
            const totalValorLiquido = vendasFiltradas.reduce((acc, v) => acc + v.valorLiquido, 0);
            const totalConsignado = vendasFiltradas.reduce((acc, v) => acc + v.consignado, 0);
            const totalVendas = vendasFiltradas.length;
            const totalPecas = vendasFiltradas.reduce((acc, v) => acc + v.pecas, 0);
            
            // CORREÇÃO: Venda Média é o valor líquido dividido pelo número de vendas
            const vendaMedia = totalVendas > 0 ? (totalValorLiquido / totalVendas) : 0;
            
            return {
                valorLiquido: totalValorLiquido,
                consignado: totalConsignado,
                vendas: totalVendas,
                pecas: totalPecas,
                vendaMedia: vendaMedia,
                itensPorVenda: totalVendas > 0 ? (totalPecas / totalVendas) : 0,
                precoMedio: totalPecas > 0 ? (totalValorLiquido / totalPecas) : 0
            };
        }

        // Funções de renderização
        function renderizarDashboard() {
            const resumo = calcularResumoGeral();
            const desempenho = calcularDesempenhoVendedoras();
            
            // Atualizar cards de estatísticas
            document.getElementById('valorLiquido').textContent = formatarMoeda(resumo.valorLiquido);
            document.getElementById('valorConsignado').textContent = formatarMoeda(resumo.consignado);
            
            // Calcular meta total (soma das metas de todas as vendedoras)
            const metaTotal = vendedoras.reduce((acc, v) => acc + v.meta, 0);
            const metaAtingidaTotal = metaTotal > 0 ? (resumo.valorLiquido / metaTotal) * 100 : 0;
            document.getElementById('metaAtingida').textContent = `${metaAtingidaTotal.toFixed(1)}%`;
            
            document.getElementById('pecasFaturadas').textContent = resumo.pecas;
            
            // Atualizar resumo do mês
            document.getElementById('vendasEfetuadas').textContent = resumo.vendas;
            document.getElementById('totalPecas').textContent = resumo.pecas;
            document.getElementById('vendaMedia').textContent = formatarMoeda(resumo.vendaMedia);
            document.getElementById('itensPorVenda').textContent = resumo.itensPorVenda.toFixed(1);
            document.getElementById('precoMedio').textContent = formatarMoeda(resumo.precoMedio);
            
            // Atualizar tabela de desempenho
            const tabelaDesempenho = document.getElementById('desempenhoTable').querySelector('tbody');
            tabelaDesempenho.innerHTML = '';
            
            desempenho.forEach(item => {
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td>${item.vendedora}</td>
                    <td>${formatarMoeda(item.meta)}</td>
                    <td>${formatarMoeda(item.valorLiquido)}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${Math.min(item.metaAtingida, 100)}%"></div>
                        </div>
                        <small>${item.metaAtingida.toFixed(1)}%</small>
                    </td>
                `;
                tabelaDesempenho.appendChild(linha);
            });
        }

        function renderizarVendedoras() {
            const tabelaVendedoras = document.getElementById('vendedorasTable').querySelector('tbody');
            tabelaVendedoras.innerHTML = '';
            
            vendedoras.forEach(vendedora => {
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td>${vendedora.nome}</td>
                    <td>${formatarMoeda(vendedora.meta)}</td>
                    <td>${vendedora.telefone}</td>
                    <td><span class="badge bg-success">${vendedora.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary editar-vendedora" data-id="${vendedora.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger excluir-vendedora" data-id="${vendedora.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabelaVendedoras.appendChild(linha);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.editar-vendedora').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editarVendedora(id);
                });
            });
            
            document.querySelectorAll('.excluir-vendedora').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    prepararExclusao('vendedora', id);
                });
            });
        }

        function renderizarVendas() {
            const tabelaVendas = document.getElementById('vendasTable').querySelector('tbody');
            tabelaVendas.innerHTML = '';
            
            // Preencher select de vendedoras no modal de vendas
            const selectVendedora = document.getElementById('vendaVendedora');
            selectVendedora.innerHTML = '<option value="" selected>Selecione...</option>';
            vendedoras.forEach(v => {
                const option = document.createElement('option');
                option.value = v.id;
                option.textContent = v.nome;
                selectVendedora.appendChild(option);
            });
            
            vendas.forEach(venda => {
                const vendedora = obterVendedoraPorId(venda.vendedoraId);
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td>${venda.data.split('-').reverse().join('/')}</td>
                    <td>${vendedora ? vendedora.nome : 'N/A'}</td>
                    <td>${formatarMoeda(venda.valorLiquido)}</td>
                    <td>${formatarMoeda(venda.consignado)}</td>
                    <td>${venda.pecas}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary editar-venda" data-id="${venda.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger excluir-venda" data-id="${venda.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabelaVendas.appendChild(linha);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.editar-venda').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editarVenda(id);
                });
            });
            
            document.querySelectorAll('.excluir-venda').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    prepararExclusao('venda', id);
                });
            });
        }

        function renderizarRelatorios() {
            // Preencher select de vendedoras no filtro
            const filtroVendedora = document.getElementById('filtroVendedora');
            filtroVendedora.innerHTML = '<option value="todas" selected>Todas</option>';
            vendedoras.forEach(v => {
                const option = document.createElement('option');
                option.value = v.id;
                option.textContent = v.nome;
                filtroVendedora.appendChild(option);
            });
            
            // Aplicar filtro padrão (mês atual)
            aplicarFiltroRelatorio();
        }

        function aplicarFiltroRelatorio() {
            const vendedoraId = document.getElementById('filtroVendedora').value;
            const periodo = document.getElementById('filtroPeriodo').value;
            
            let dataInicio = document.getElementById('dataInicio').value;
            let dataFim = document.getElementById('dataFim').value;
            
            // Se o período for personalizado mas as datas não foram definidas, usar mês atual
            if (periodo === 'custom' && (!dataInicio || !dataFim)) {
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                dataInicio = formatarData(primeiroDiaMes);
                dataFim = formatarData(ultimoDiaMes);
                
                document.getElementById('dataInicio').value = dataInicio;
                document.getElementById('dataFim').value = dataFim;
            }
            
            // Filtrar vendas
            let vendasFiltradas = [...vendas];
            
            // Filtrar por vendedora
            if (vendedoraId !== 'todas') {
                vendasFiltradas = vendasFiltradas.filter(v => v.vendedoraId === parseInt(vendedoraId));
            }
            
            // Filtrar por período
            if (periodo !== 'custom') {
                const hoje = new Date();
                let dataInicioFiltro;
                
                switch (periodo) {
                    case 'day':
                        dataInicioFiltro = new Date(hoje);
                        dataFim = formatarData(hoje);
                        break;
                    case 'week':
                        dataInicioFiltro = new Date(hoje);
                        dataInicioFiltro.setDate(hoje.getDate() - hoje.getDay());
                        dataFim = formatarData(new Date(hoje));
                        break;
                    case 'month':
                        dataInicioFiltro = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                        dataFim = formatarData(new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0));
                        break;
                    case 'year':
                        dataInicioFiltro = new Date(hoje.getFullYear(), 0, 1);
                        dataFim = formatarData(new Date(hoje.getFullYear(), 11, 31));
                        break;
                }
                
                dataInicio = formatarData(dataInicioFiltro);
                document.getElementById('dataInicio').value = dataInicio;
                document.getElementById('dataFim').value = dataFim;
            }
            
            // Aplicar filtro de data
            vendasFiltradas = vendasFiltradas.filter(v => {
                return v.data >= dataInicio && v.data <= dataFim;
            });
            
            // Calcular desempenho com base nas vendas filtradas
            const desempenho = calcularDesempenhoVendedoras(vendasFiltradas);
            dadosFiltrados = desempenho;
            
            // Renderizar tabela de relatório
            const tabelaRelatorio = document.getElementById('reportTable').querySelector('tbody');
            tabelaRelatorio.innerHTML = '';
            
            desempenho.forEach(item => {
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td>${item.vendedora}</td>
                    <td>${formatarMoeda(item.meta)}</td>
                    <td>${formatarMoeda(item.valorLiquido)}</td>
                    <td>${formatarMoeda(item.consignado)}</td>
                    <td>${formatarMoeda(item.total)}</td>
                    <td>${item.metaAtingida.toFixed(1)}%</td>
                    <td>${item.vendas}</td>
                    <td>${item.pecas}</td>
                    <td>${formatarMoeda(item.vendaMedia)}</td>
                    <td>${item.itensPorVenda.toFixed(1)}</td>
                    <td>${formatarMoeda(item.precoMedio)}</td>
                `;
                tabelaRelatorio.appendChild(linha);
            });
        }

        // Funções de manipulação de dados
        function salvarVendedora() {
            const id = document.getElementById('vendedoraId').value;
            const nome = document.getElementById('vendedoraNome').value;
            const meta = parseFloat(document.getElementById('vendedoraMeta').value);
            const telefone = document.getElementById('vendedoraTelefone').value;
            const email = document.getElementById('vendedoraEmail').value;
            
            if (id) {
                // Editar vendedora existente
                const index = vendedoras.findIndex(v => v.id === parseInt(id));
                if (index !== -1) {
                    vendedoras[index] = {
                        ...vendedoras[index],
                        nome,
                        meta,
                        telefone,
                        email
                    };
                }
            } else {
                // Adicionar nova vendedora
                const novoId = vendedoras.length > 0 ? Math.max(...vendedoras.map(v => v.id)) + 1 : 1;
                vendedoras.push({
                    id: novoId,
                    nome,
                    meta,
                    telefone,
                    email,
                    status: "Ativa"
                });
            }
            
            localStorage.setItem('vendedoras', JSON.stringify(vendedoras));
            
            // Fechar modal e atualizar interface
            bootstrap.Modal.getInstance(document.getElementById('addVendedoraModal')).hide();
            renderizarVendedoras();
            renderizarDashboard();
            renderizarVendas();
            
            // Limpar formulário
            document.getElementById('formVendedora').reset();
            document.getElementById('vendedoraId').value = '';
        }

        function editarVendedora(id) {
            const vendedora = vendedoras.find(v => v.id === id);
            if (vendedora) {
                document.getElementById('vendedoraId').value = vendedora.id;
                document.getElementById('vendedoraNome').value = vendedora.nome;
                document.getElementById('vendedoraMeta').value = vendedora.meta;
                document.getElementById('vendedoraTelefone').value = vendedora.telefone;
                document.getElementById('vendedoraEmail').value = vendedora.email;
                
                const modal = new bootstrap.Modal(document.getElementById('addVendedoraModal'));
                modal.show();
            }
        }

        function salvarVenda() {
            const id = document.getElementById('vendaId').value;
            const data = document.getElementById('vendaData').value;
            const vendedoraId = parseInt(document.getElementById('vendaVendedora').value);
            const valorLiquido = parseFloat(document.getElementById('vendaValorLiquido').value);
            const consignado = parseFloat(document.getElementById('vendaConsignado').value);
            const pecas = parseInt(document.getElementById('vendaPecas').value);
            
            if (id) {
                // Editar venda existente
                const index = vendas.findIndex(v => v.id === parseInt(id));
                if (index !== -1) {
                    vendas[index] = {
                        ...vendas[index],
                        data,
                        vendedoraId,
                        valorLiquido,
                        consignado,
                        pecas
                    };
                }
            } else {
                // Adicionar nova venda
                const novoId = vendas.length > 0 ? Math.max(...vendas.map(v => v.id)) + 1 : 1;
                vendas.push({
                    id: novoId,
                    data,
                    vendedoraId,
                    valorLiquido,
                    consignado,
                    pecas
                });
            }
            
            localStorage.setItem('vendas', JSON.stringify(vendas));
            
            // Fechar modal e atualizar interface
            bootstrap.Modal.getInstance(document.getElementById('addVendaModal')).hide();
            renderizarVendas();
            renderizarDashboard();
            
            // Limpar formulário
            document.getElementById('formVenda').reset();
            document.getElementById('vendaId').value = '';
        }

        function editarVenda(id) {
            const venda = vendas.find(v => v.id === id);
            if (venda) {
                document.getElementById('vendaId').value = venda.id;
                document.getElementById('vendaData').value = venda.data;
                document.getElementById('vendaVendedora').value = venda.vendedoraId;
                document.getElementById('vendaValorLiquido').value = venda.valorLiquido;
                document.getElementById('vendaConsignado').value = venda.consignado;
                document.getElementById('vendaPecas').value = venda.pecas;
                
                const modal = new bootstrap.Modal(document.getElementById('addVendaModal'));
                modal.show();
            }
        }

        function prepararExclusao(tipo, id) {
            itemParaExcluir = id;
            tipoItemParaExcluir = tipo;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        function confirmarExclusao() {
            if (tipoItemParaExcluir === 'vendedora') {
                // Verificar se a vendedora tem vendas associadas
                const vendasVendedora = vendas.filter(v => v.vendedoraId === itemParaExcluir);
                if (vendasVendedora.length > 0) {
                    alert('Não é possível excluir esta vendedora pois existem vendas associadas a ela.');
                    return;
                }
                
                vendedoras = vendedoras.filter(v => v.id !== itemParaExcluir);
                localStorage.setItem('vendedoras', JSON.stringify(vendedoras));
                renderizarVendedoras();
                renderizarDashboard();
                renderizarVendas();
            } else if (tipoItemParaExcluir === 'venda') {
                vendas = vendas.filter(v => v.id !== itemParaExcluir);
                localStorage.setItem('vendas', JSON.stringify(vendas));
                renderizarVendas();
                renderizarDashboard();
            }
            
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
        }

        function exportarBackup() {
            const dados = {
                vendedoras: vendedoras,
                vendas: vendas,
                exportadoEm: new Date().toISOString()
            };
            
            const dadosStr = JSON.stringify(dados, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dadosStr);
            
            const exportFileDefaultName = `salescontrol_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importarBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo de backup.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (!dados.vendedoras || !dados.vendas) {
                        throw new Error('Formato de arquivo inválido');
                    }
                    
                    if (confirm('Tem certeza que deseja importar os dados? Todos os dados atuais serão substituídos.')) {
                        vendedoras = dados.vendedoras;
                        vendas = dados.vendas;
                        
                        localStorage.setItem('vendedoras', JSON.stringify(vendedoras));
                        localStorage.setItem('vendas', JSON.stringify(vendas));
                        
                        // Atualizar toda a interface
                        renderizarDashboard();
                        renderizarVendedoras();
                        renderizarVendas();
                        renderizarRelatorios();
                        
                        alert('Dados importados com sucesso!');
                        bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
                    }
                } catch (error) {
                    console.error(error);
                    alert('Erro ao importar dados. O arquivo pode estar corrompido ou em formato inválido.');
                }
            };
            reader.readAsText(file);
        }

        function gerarPDF() {
            // Verificar se a biblioteca jsPDF está disponível
            if (typeof window.jspdf !== 'undefined') {
                const { jsPDF } = window.jspdf;
                
                // Criar novo documento PDF
                const doc = new jsPDF();
                
                // Adicionar título
                doc.setFontSize(20);
                doc.text('Relatório SalesControl', 105, 15, { align: 'center' });
                
                // Adicionar data de geração
                doc.setFontSize(12);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
                
                // Adicionar informações de filtro
                const vendedoraFiltro = document.getElementById('filtroVendedora');
                const vendedoraNome = vendedoraFiltro.value === 'todas' ? 'Todas' : 
                    vendedoras.find(v => v.id === parseInt(vendedoraFiltro.value))?.nome || 'N/A';
                
                const periodoFiltro = document.getElementById('filtroPeriodo');
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                
                doc.setFontSize(10);
                doc.text(`Vendedora: ${vendedoraNome}`, 14, 30);
                doc.text(`Período: ${periodoFiltro.options[periodoFiltro.selectedIndex].text}`, 14, 35);
                doc.text(`De: ${dataInicio.split('-').reverse().join('/')} até: ${dataFim.split('-').reverse().join('/')}`, 14, 40);
                
                // Preparar dados para a tabela
                const tableColumn = [
                    "Vendedora", 
                    "Meta", 
                    "Valor Líquido", 
                    "Consignado", 
                    "Total", 
                    "Meta Atingida", 
                    "Vendas", 
                    "Peças"
                ];
                
                const tableRows = [];
                
                dadosFiltrados.forEach(item => {
                    const dataRow = [
                        item.vendedora,
                        formatarMoeda(item.meta),
                        formatarMoeda(item.valorLiquido),
                        formatarMoeda(item.consignado),
                        formatarMoeda(item.total),
                        `${item.metaAtingida.toFixed(1)}%`,
                        item.vendas,
                        item.pecas
                    ];
                    tableRows.push(dataRow);
                });
                
                // Adicionar tabela ao PDF
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 45,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [67, 97, 238] }
                });
                
                // Adicionar totais
                const valorLiquidoTotal = dadosFiltrados.reduce((acc, item) => acc + item.valorLiquido, 0);
                const consignadoTotal = dadosFiltrados.reduce((acc, item) => acc + item.consignado, 0);
                const totalGeral = valorLiquidoTotal + consignadoTotal;
                const vendasTotal = dadosFiltrados.reduce((acc, item) => acc + item.vendas, 0);
                const pecasTotal = dadosFiltrados.reduce((acc, item) => acc + item.pecas, 0);
                
                const finalY = doc.lastAutoTable.finalY + 10;
                
                doc.setFontSize(10);
                doc.setDrawColor(0);
                doc.setFillColor(240, 240, 240);
                doc.rect(14, finalY, 182, 20, 'F');
                
                doc.text(`TOTAL LÍQUIDO: ${formatarMoeda(valorLiquidoTotal)}`, 20, finalY + 7);
                doc.text(`TOTAL CONSIGNADO: ${formatarMoeda(consignadoTotal)}`, 20, finalY + 14);
                doc.text(`TOTAL GERAL: ${formatarMoeda(totalGeral)}`, 110, finalY + 7);
                doc.text(`TOTAL VENDAS: ${vendasTotal}`, 110, finalY + 14);
                doc.text(`TOTAL PEÇAS: ${pecasTotal}`, 160, finalY + 7);
                
                // Salvar o PDF
                doc.save(`relatorio_salescontrol_${new Date().toISOString().split('T')[0]}.pdf`);
            } else {
                alert('Erro: Biblioteca de geração de PDF não carregada. Tente recarregar a página.');
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar a interface
            renderizarDashboard();
            renderizarVendedoras();
            renderizarVendas();
            renderizarRelatorios();
            
            // Definir data atual como padrão no formulário de vendas
            document.getElementById('vendaData').value = formatarData(new Date());
            
            // Event Listeners para navegação
            document.getElementById('dashboardLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('dashboardSection');
                atualizarLinkAtivo(this);
            });
            
            document.getElementById('vendedorasLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('vendedorasSection');
                atualizarLinkAtivo(this);
            });
            
            document.getElementById('vendasLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('vendasSection');
                atualizarLinkAtivo(this);
            });
            
            document.getElementById('relatoriosLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('relatoriosSection');
                atualizarLinkAtivo(this);
            });
            
            document.getElementById('configuracoesLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('configuracoesSection');
                atualizarLinkAtivo(this);
            });
            
            document.getElementById('dashboardBrandLink').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao('dashboardSection');
                atualizarLinkAtivo(document.getElementById('dashboardLink'));
            });
            
            // Event Listeners para formulários
            document.getElementById('salvarVendedora').addEventListener('click', salvarVendedora);
            document.getElementById('salvarVenda').addEventListener('click', salvarVenda);
            
            // Event Listener para confirmação de exclusão
            document.getElementById('confirmDelete').addEventListener('click', confirmarExclusao);
            
            // Event Listeners para backup
            document.getElementById('exportBackup').addEventListener('click', exportarBackup);
            document.getElementById('importBackup').addEventListener('click', importarBackup);
            
            // Event Listener para filtro de período no dashboard
            document.getElementById('periodFilter').addEventListener('change', renderizarDashboard);
            
            // Event Listeners para relatórios
            document.getElementById('aplicarFiltro').addEventListener('click', aplicarFiltroRelatorio);
            document.getElementById('generatePdf').addEventListener('click', gerarPDF);
            
            // Event Listener para mostrar/ocultar datas personalizadas
            document.getElementById('filtroPeriodo').addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('dataInicio').disabled = !isCustom;
                document.getElementById('dataFim').disabled = !isCustom;
            });
            
            // Inicializar estado dos campos de data
            document.getElementById('dataInicio').disabled = true;
            document.getElementById('dataFim').disabled = true;
        });

        function mostrarSecao(secaoId) {
            // Ocultar todas as seções
            document.querySelectorAll('.main-content > div').forEach(secao => {
                secao.style.display = 'none';
            });
            
            // Mostrar a seção solicitada
            document.getElementById(secaoId).style.display = 'block';
        }

        function atualizarLinkAtivo(link) {
            // Remover a classe active de todos os links
            document.querySelectorAll('.sidebar .nav-link').forEach(item => {
                item.classList.remove('active');
            });
            
            // Adicionar a classe active ao link clicado
            link.classList.add('active');
        }
    </script>
</body>
</html>